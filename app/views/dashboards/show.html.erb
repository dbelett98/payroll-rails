<div class="dashboard-wrapper">
  <!-- Enhanced Client Selection Bar -->
  <div class="client-bar">
    <%= form_with url: dashboard_path, method: :get, local: true, class: "client-form" do |f| %>
      <%= f.select :client_id, 
          options_for_select(@clients.map { |c| [c.name, c.id] }, @selected_client&.id),
          { prompt: "Select Client" },
          { class: "client-select", onchange: "this.form.submit();" } %>
    <% end %>
    
    <!-- NEW: Search and Filter Bar -->
    <div class="search-filter-bar">
      <%= form_with url: dashboard_path, method: :get, local: true, class: "search-form" do |f| %>
        <%= f.hidden_field :client_id, value: @selected_client&.id %>
        <%= f.text_field :search, placeholder: "Search employees...", value: params[:search], class: "search-input" %>
        <%= f.select :status, [['All', ''], ['Active', 'active'], ['Inactive', 'inactive']], 
                    { selected: params[:status] }, { class: "filter-select" } %>
        <%= f.submit 'Filter', class: 'btn btn-primary' %>
      <% end %>
    </div>
    
    <div style="display: flex; gap: 1rem;">
      <button id="manage-clients-btn" class="btn btn-primary">
        <span class="btn-icon">üè¢</span> Manage Clients
      </button>
      <button id="add-employee-btn" class="btn btn-primary">
        <span class="btn-icon">+</span> Add New Employee
      </button>
    </div>
  </div>

  <!-- Enhanced Main Dashboard Grid -->
  <div class="dashboard-grid">
    <!-- Client Overview - Enhanced with more stats -->
    <div class="card card-overview">
      <div class="card-header">
        <span class="card-icon">üìä</span>
        <h2>Client Overview</h2>
      </div>
      <div class="card-body">
        <div class="overview-stats">
          <div class="stat-item">
            <span class="stat-label">Total Employees</span>
            <span class="stat-value"><%= @employees.count %></span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Active</span>
            <span class="stat-value"><%= @employees.select { |e| e.respond_to?(:status) && e.status == 'active' }.count rescue @employees.count %></span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Total Payroll</span>
            <span class="stat-value">$<%= number_with_delimiter(@employees.sum(&:calculate_pay).round(2)) %></span>
          </div>
        </div>
        <p class="overview-description">Comprehensive client analytics and employee insights</p>
      </div>
    </div>

    <!-- Payroll Status - Keep existing -->
    <div class="card card-status">
      <div class="card-header">
        <span class="card-icon">üí∞</span>
        <h2>Payroll Status</h2>
      </div>
      <div class="card-body">
        <div class="status-indicator">
          <span class="status-badge status-active">Active</span>
          <span class="status-text">Next payroll: <%= (Date.today + 7.days).strftime("%B %d, %Y") %></span>
        </div>
        <p class="status-description">Real-time payroll processing updates and status monitoring</p>
      </div>
    </div>

    <!-- Reports - Keep existing -->
    <div class="card card-reports">
      <div class="card-header">
        <span class="card-icon">üìà</span>
        <h2>Reports</h2>
      </div>
      <div class="card-body">
        <div class="report-links">
          <a href="#" class="report-link">Payroll Register</a>
          <a href="#" class="report-link">Tax Summary</a>
          <a href="#" class="report-link">YTD Earnings</a>
        </div>
        <p class="reports-description">Advanced reporting and data insights for informed decisions</p>
      </div>
    </div>
  </div>

  <!-- Enhanced Employee Directory -->
  <div class="employee-section">
    <div class="section-header">
      <h2 class="section-title">
        <span class="section-icon">üë•</span>
        Employee Directory
      </h2>
    </div>
    
    <% if @employees.any? %>
      <div class="table-container">
        <table class="employee-table">
          <thead>
            <tr>
              <th class="th-name">Name</th>
              <th class="th-title">Title</th>
              <th class="th-hours">Hours</th>
              <th class="th-salary">Salary</th>
              <th class="th-pay">Pay</th>
              <th class="th-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @employees.each do |employee| %>
              <tr>
                <td class="td-name">
                  <%= link_to employee.name, employee_path(employee), class: 'employee-name-link' %>
                </td>
                <td class="td-title"><%= employee.title || 'Not specified' %></td>
                <td class="td-hours"><%= number_with_precision(employee.hours_worked, precision: 1) %></td>
                <td class="td-salary">$<%= number_with_delimiter(employee.salary) %></td>
                <td class="td-pay">$<%= number_with_delimiter(employee.calculate_pay.round(2)) %></td>
                <td class="td-actions">
                  <div class="action-buttons">
                    <button class="btn-edit" onclick="openEditModal(<%= employee.id %>, '<%= employee.name %>', <%= employee.salary %>, <%= employee.hours_worked %>, '<%= employee.title %>')">Edit</button>
                    <%= button_to "Delete", employee_path(employee), method: :delete, 
                        data: { confirm: "Are you sure?" }, class: "btn-delete" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="empty-state">
        <p>No employees found for the selected client.</p>
        <% if @selected_client %>
          <button type="button" class="action-btn primary-btn" onclick="openAddModal()">
            Add First Employee
          </button>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Enhanced Employee Modal with Tabs -->
<div id="employee-modal" class="modal">
  <div class="modal-content enhanced-modal">
    <div class="modal-header">
      <h3 id="modal-title">Add New Employee</h3>
      <span class="modal-close">&times;</span>
    </div>
    <div class="modal-body">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button type="button" class="tab-btn active" onclick="showTab('basic')">Basic Info</button>
        <button type="button" class="tab-btn" onclick="showTab('payroll')">Payroll</button>
        <button type="button" class="tab-btn" onclick="showTab('contact')">Contact</button>
      </div>

      <form id="employee-form" action="/employees" method="post" class="employee-form enhanced-form">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <input type="hidden" id="employee-id" name="employee_id" value="">
        <input type="hidden" id="form-method" name="_method" value="post">
        
        <!-- Basic Info Tab -->
        <div id="basicTab" class="tab-content active">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Full Name *</label>
              <input type="text" id="employee-name" name="employee[name]" placeholder="Enter employee name" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Job Title *</label>
              <select id="employee-title" name="employee[title]" class="form-input" required>
                <option value="">Select Title</option>
                <option value="Manager">Manager</option>
                <option value="Developer">Developer</option>
                <option value="Designer">Designer</option>
                <option value="HR">HR</option>
                <option value="Sales">Sales</option>
                <option value="Support">Support</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Payroll Tab -->
        <div id="payrollTab" class="tab-content">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Annual Salary *</label>
              <input type="number" id="employee-salary" name="employee[salary]" placeholder="$0.00" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Hours Worked</label>
              <input type="number" id="employee-hours" name="employee[hours_worked]" step="0.1" placeholder="40" class="form-input">
            </div>
          </div>
        </div>

        <!-- Contact Tab -->
        <div id="contactTab" class="tab-content">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" id="employee-phone" name="employee[phone]" 
                     placeholder="(XXX) XXX-XXXX" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">SSN</label>
              <input type="text" id="employee-ssn" name="employee[ssn]" 
                     placeholder="XXX-XX-XXXX" maxlength="11" class="form-input">
            </div>
          </div>
        </div>
        
        <input type="hidden" name="employee[client_id]" value="<%= @selected_client&.id %>">
        
        <div class="form-actions">
          <button type="button" class="btn btn-cancel">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submit-btn">Add Employee</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Your Existing Client Management Modal (keeping exactly as is) -->
<div id="client-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="client-modal-title">Manage Clients</h3>
      <span class="modal-close" onclick="closeClientModal()">&times;</span>
    </div>
    <div class="modal-body">
      <!-- Client List -->
      <div id="client-list" class="client-list">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4>Your Clients</h4>
          <button type="button" class="btn btn-primary" onclick="showClientForm()">
            <span class="btn-icon">+</span> Add Client
          </button>
        </div>
        
        <div class="clients-table">
          <% @clients.each do |client| %>
            <div class="client-row">
              <div class="client-info">
                <div class="client-name"><%= client.name %></div>
                <div class="client-details">
                  <%= client.employees.count %> employees ‚Ä¢ 
                  <% if client.email.present? %><%= client.email %><% else %>No email<% end %>
                </div>
              </div>
              <div class="client-actions">
                <button class="btn-edit" onclick="editClient(<%= client.id %>, '<%= client.name %>', '<%= client.bank_account %>', '<%= client.ein %>', '<%= client.address %>', '<%= client.phone %>', '<%= client.email %>')">Edit</button>
                <% if @clients.count > 1 %>
                  <%= button_to "Delete", client_path(client), method: :delete, 
                      data: { confirm: "Are you sure? This will delete all employees for this client." }, 
                      class: "btn-delete", form: { style: "display: inline;" } %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Client Form -->
      <div id="client-form" class="client-form" style="display: none;">
        <form id="client-form-element" action="/clients" method="post">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <input type="hidden" id="client-id" name="client_id" value="">
          <input type="hidden" id="client-form-method" name="_method" value="post">
          
          <div class="form-group">
            <label class="form-label">Company Name</label>
            <input type="text" id="client-name" name="client[name]" placeholder="Enter company name" class="form-input" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">EIN <span style="font-size: 0.8em; color: #6b7280;">(Format: XX-XXXXXXX)</span></label>
              <input type="text" id="client-ein" name="client[ein]" placeholder="12-3456789" class="form-input" maxlength="10" data-mask="ein">
            </div>
            
            <div class="form-group">
              <label class="form-label">Phone <span style="font-size: 0.8em; color: #6b7280;">(Format: (XXX) XXX-XXXX)</span></label>
              <input type="text" id="client-phone" name="client[phone]" placeholder="(555) 123-4567" class="form-input" maxlength="14" data-mask="phone">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" id="client-email" name="client[email]" placeholder="contact@company.com" class="form-input">
            </div>
            
            <div class="form-group">
              <label class="form-label">Bank Account</label>
              <input type="text" id="client-bank" name="client[bank_account]" placeholder="Account ending in XXXX" class="form-input">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Address</label>
            <textarea id="client-address" name="client[address]" placeholder="123 Business St, City, State 12345" class="form-input" rows="3"></textarea>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-cancel" onclick="showClientList()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="client-submit-btn">Add Client</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  /* Enhanced styles for tabbed modal */
  .enhanced-modal {
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .tab-navigation {
    display: flex;
    border-bottom: 2px solid #f1f5f9;
    margin-bottom: 2rem;
  }
  
  .tab-btn {
    padding: 1rem 1.5rem;
    background: none;
    border: none;
    color: #4a5568;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
  }
  
  .tab-btn.active {
    color: #667eea;
    border-bottom-color: #667eea;
  }
  
  .tab-content {
    display: none;
  }
  
  .tab-content.active {
    display: block;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }
  
  .search-filter-bar {
    display: flex;
    gap: 1rem;
    align-items: end;
    flex-wrap: wrap;
  }
  
  .search-input {
    flex: 1;
    min-width: 200px;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
  }
  
  .filter-select {
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    background: white;
  }
  
  /* Keep all your existing client modal styles */
  .client-list {
    max-height: 400px;
    overflow-y: auto;
  }
  
  .clients-table {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .client-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  
  .client-info {
    flex: 1;
  }
  
  .client-name {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
  }
  
  .client-details {
    font-size: 0.875rem;
    color: #6b7280;
  }
  
  .client-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .client-form {
    animation: slideIn 0.3s ease;
  }
  
  .employee-name-link {
    color: #3182ce;
    text-decoration: none;
    font-weight: 600;
  }
  
  .employee-name-link:hover {
    color: #2c5aa0;
    text-decoration: underline;
  }
</style>

<script>
  // Enhanced JavaScript
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('employee-modal');
    const addBtn = document.getElementById('add-employee-btn');
    const closeBtn = document.querySelector('.modal-close');
    const cancelBtn = document.querySelector('.btn-cancel');
    const form = document.getElementById('employee-form');
    const modalTitle = document.getElementById('modal-title');
    const submitBtn = document.getElementById('submit-btn');
    const formMethod = document.getElementById('form-method');
    
    // Add New Employee button
    addBtn.onclick = function() {
      modalTitle.textContent = 'Add New Employee';
      submitBtn.textContent = 'Add Employee';
      form.action = '/employees';
      formMethod.value = 'post';
      form.reset();
      document.getElementById('employee-id').value = '';
      modal.style.display = 'block';
      showTab('basic');
    }
    
    // Close modal functions
    closeBtn.onclick = function() {
      modal.style.display = 'none';
    }
    
    cancelBtn.onclick = function() {
      modal.style.display = 'none';
    }
    
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
  });
  
  // Tab functionality
  function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab
    document.getElementById(tabName + 'Tab').classList.add('active');
    event.target.classList.add('active');
  }
  
  // Edit Employee function
  function openEditModal(id, name, salary, hours, title) {
    const modal = document.getElementById('employee-modal');
    const form = document.getElementById('employee-form');
    const modalTitle = document.getElementById('modal-title');
    const submitBtn = document.getElementById('submit-btn');
    const formMethod = document.getElementById('form-method');
    
    modalTitle.textContent = 'Edit Employee';
    submitBtn.textContent = 'Update Employee';
    form.action = '/employees/' + id;
    formMethod.value = 'patch';
    
    document.getElementById('employee-id').value = id;
    document.getElementById('employee-name').value = name;
    document.getElementById('employee-salary').value = salary;
    document.getElementById('employee-hours').value = hours;
    document.getElementById('employee-title').value = title || '';
    
    modal.style.display = 'block';
    showTab('basic');
  }

  // Keep ALL your existing Client Management JavaScript exactly as is
  document.getElementById('manage-clients-btn').onclick = function() {
    document.getElementById('client-modal').style.display = 'block';
    showClientList();
  }
  
  function closeClientModal() {
    document.getElementById('client-modal').style.display = 'none';
  }
  
  function showClientList() {
    document.getElementById('client-list').style.display = 'block';
    document.getElementById('client-form').style.display = 'none';
    document.getElementById('client-modal-title').textContent = 'Manage Clients';
  }
  
  function setupInputMasking() {
    // EIN Masking: XX-XXXXXXX
    const einInput = document.getElementById('client-ein');
    if (einInput) {
      einInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length >= 2) {
          value = value.substring(0, 2) + '-' + value.substring(2, 9);
        }
        e.target.value = value;
      });
    }
    
    // Phone Masking: (XXX) XXX-XXXX
    const phoneInput = document.getElementById('client-phone');
    if (phoneInput) {
      phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length > 0) {
          if (value.length <= 3) {
            value = `(${value}`;
          } else if (value.length <= 6) {
            value = `(${value.substring(0, 3)}) ${value.substring(3)}`;
          } else {
            value = `(${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6, 10)}`;
          }
        }
        e.target.value = value;
      });
    }
  }
  
  function showClientForm() {
    document.getElementById('client-list').style.display = 'none';
    document.getElementById('client-form').style.display = 'block';
    document.getElementById('client-modal-title').textContent = 'Add New Client';
    
    const form = document.getElementById('client-form-element');
    form.action = '/clients';
    document.getElementById('client-form-method').value = 'post';
    document.getElementById('client-submit-btn').textContent = 'Add Client';
    form.reset();
    
    setupInputMasking();
  }
  
  function editClient(id, name, bankAccount, ein, address, phone, email) {
    showClientForm();
    document.getElementById('client-modal-title').textContent = 'Edit Client';
    
    const form = document.getElementById('client-form-element');
    form.action = '/clients/' + id;
    document.getElementById('client-form-method').value = 'patch';
    document.getElementById('client-submit-btn').textContent = 'Update Client';
    
    document.getElementById('client-id').value = id;
    document.getElementById('client-name').value = name;
    document.getElementById('client-bank').value = bankAccount || '';
    document.getElementById('client-ein').value = ein || '';
    document.getElementById('client-address').value = address || '';
    document.getElementById('client-phone').value = phone || '';
    document.getElementById('client-email').value = email || '';
    
    setupInputMasking();
  }
  
  // Close client modal when clicking outside
  window.onclick = function(event) {
    const clientModal = document.getElementById('client-modal');
    const employeeModal = document.getElementById('employee-modal');
    
    if (event.target == clientModal) {
      closeClientModal();
    } else if (event.target == employeeModal) {
      employeeModal.style.display = 'none';
    }
  }
</script>